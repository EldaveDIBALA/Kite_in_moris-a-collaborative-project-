<div class="container my-5">
  <div class="text-center mb-4">
    <h1 class="display-4">Schools</h1>
  </div>

  <div class="filter-buttons mb-4">
    <div class="row mb-2">
      <div class="col-md-12 d-flex justify-content-center">
        <%= button_to 'All', schools_path, method: :get, class: "btn btn-outline-secondary w-50" %>
      </div>
    </div>

    <div class="row">
      <% @locations.each_slice(3).with_index do |location_group, group_index| %>
        <div class="col-md-12 d-flex justify-content-center">
          <% location_group.each do |location| %>
            <div class="col-md-2 mb-2">
              <%= button_to location.name, schools_path(location_id: location.id), method: :get, class: "btn btn-outline-primary w-100" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <div id="schools-list" class="row justify-content-center">
    <% @schools.each do |school| %>
      <div class="col-md-4 mb-4">
        <div class="card shadow-sm h-100">
          <!--<img src="<%#= school.image_url || 'default-image.jpg' %>" class="card-img-top" alt="<%= school.name %> image">-->
          <div class="card-body">
            <h5 class="card-title"><%= school.name %></h5>
            <p class="card-text"><%= truncate(school.description, length: 100) %></p>
            <p class="card-text">
              <i class="fas fa-map-marker-alt me-1"></i> <%= school.address %>
            </p>
            <p class="card-text">
              <i class="fas fa-phone me-1"></i> <%= school.phone %>
            </p>
            <p class="card-text">
              <i class="fas fa-globe me-1"></i> <%= link_to 'Website', school.website, target: '_blank' %>
            </p>
            <%= link_to 'Link to Show', school_path(school), class: 'btn btn-primary' %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="text-center my-4">
    <div class="btn-group" role="group" aria-label="Basic example">
      <%= button_to schools_path(location_id: params[:location_id], offset: (@schools.count + (params[:offset] || 0).to_i)),
                    remote: true,
                    method: :get,
                    class: "btn btn-outline-secondary d-flex align-items-center me-3",
                    id: "load-more" do %>
        <i class="fas fa-plus me-2"></i>
        Load More
      <% end %>

      <%= link_to new_school_path,
                  class: 'btn btn-outline-success d-flex align-items-center',
                  role: 'button' do %>
        <i class="fas fa-school me-2"></i>
        Create your company
      <% end %>
    </div>
  </div>

  <div id="map" class="my-4 mb-4 rounded shadow" style="height: 400px;"></div>

</div>

<script>
  document.addEventListener("turbo:load", function() {
    const loadMoreButton = document.getElementById("load-more");

    if (loadMoreButton) {
      loadMoreButton.addEventListener("click", function(e) {
        e.preventDefault();

        fetch(this.href, { headers: { "Accept": "text/vnd.turbo-stream.html" } })
          .then(response => response.text())
          .then(html => {
            document.getElementById("schools-list").insertAdjacentHTML("beforeend", html);
            if (html.trim() === "") {
              loadMoreButton.style.display = "none";
            }
          });
      });
    }
  });

  document.addEventListener("DOMContentLoaded", function() {
    mapboxgl.accessToken = 'your_mapbox_access_token';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [2.3522, 48.8566],
      zoom: 12
    });

    // Add markers to the map
    const markers = <%= raw @markers.to_json %>;
    markers.forEach((marker) => {
      new mapboxgl.Marker()
        .setLngLat([marker.lng, marker.lat])
        .setPopup(new mapboxgl.Popup().setHTML(marker.info_window)) 
      });
  });
</script>
